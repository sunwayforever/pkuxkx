#class hubiao open
load hubiao_score;

#var hb_max_path_size 45;

#var hb_auto 0;
#var hb_rotate 0;
#var hb_dest nil;

#var getesc_current_score 0;
#var getesc_current_id 0;

#var hb_first_kill 0;
#var hb_paused 0;
#var hb_info nil;
#var hb_rotate_location NIL;
#var hb_rotate_location_count 0;
#var hb_robber_count 0;

#alias {hb.teardown} {
    #var quest NIL;
    #var hb_robber_count 0;
    #class hb_setup_inner kill;
    #class clear_npc.inner kill;
    #unticker {hb_ticker};
};

#alias {hb.traverse} {
    #alias {auto_pp_done} {
        #var gps_traverse_location %%1;
        #alias {gps_check_room_done} {
            #if {${gps.roomno} == -1} {
                #delay {1} {
                    show_to_info µ±Ç°·¿¼äÎ´¼ÇÂ¼, ÎÞ·¨±éÀú»ï¼Æ;
                };
            };
            #else {
                INVOKE gps.traverse ${gps.roomno} ${gps_traverse_location};
                #var hb_path ${gps_path};
                #var hb_path_index 1;
                #list hb_path size hb_path_size;
                #var hb_paused 0;
                #if {${hb_path_size} == 0} {
                    show_to_info ÎÞ·¨±éÀú»ï¼Æ;
                };
                #else {
                    hb.run;
                };
            };  
        };
        #if {"${gps_traverse_location}" == "NULL"} {
            show_to_info »ï¼Æ²»´æÔÚ;
            hb.b;
        };
        #else {
            gps.check_room {
                gps_check_room_done;
            };
        };
    };

    autopp {
        auto_pp_done;
    };
};

#alias {hb.run} {
    #list hb_path get ${hb_path_index} hb_next_step;
    #if {@startwith{${hb_next_step};gps}} {
        #replace {hb_next_step} {gps} {hb};
    };
    #else {
        #var hb_next_step gan che to ${hb_next_step};
    };
    #if {${qx_percent} < 50 || ${js_percent} < 50 || ${nl_percent} < 20} {
        #delay {hb_move} {
            show_to_info ÆøÑª»ò¾«Éñ¹ýµÍ,ÍÆ³µÔÝÍ£;
            notify escort paused;
            on_truce {
                on_health {hb.run};
            };
        } {3};
    };
    #else {
        #if {${hb_path_index} > ${hb_path_size}} {
            hb.pause;
            #delay {hb_move} {
                #if {"@getenv{hb_state}" == "STARTED"} {
                    @setenv{hb_state;TRAVERSE};
                };
                hb.resume;
            } {3};
        };
        #else {
            #if {${eff_qx_percent} < 95} {
                #2 yun heal;
            };
            #if {${eff_qx_percent} < 50} {
                #2 yun lifeheal;
            };
            #delay {hb_move} {
                #if {${hb_paused} == 0} {
                    ${hb_next_step};
                };
            } {3};
        };
    };
};

#var hb_retry_count 0;
#alias {hb.setup} {
    #var quest hb;
    #class hb_setup_inner open;

    #alias {hb.guohe} {
        #class guohe.inner open;
        #ticker {sw/yell_boat} {
            yell boat;
        } {5};
        #action {ÕýµÈ×ÅÄãÄØ£¬ÉÏÀ´°É¡£} {
            gan che to enter;
        };
        #action {ô¹¹«½«Ò»¿éÌ¤½Å°å´îÉÏµÌ°¶£¬} {
            gan che to enter;
        };
        #alias {shangchuan} {
            #unticker {sw/yell_boat};
            #action {ËùÓÐÈË±»¸ÏÏÂÁË¶É´¬} {
                #unaction {ËùÓÐÈË±»¸ÏÏÂÁË¶É´¬};
                #class guohe.inner kill;
                #math hb_path_index ${hb_path_index}+1;
                #var hb_paused 0;
                hb.run;
            };
        };
        #action {^»ÆºÓ¶É´¬$} {
            shangchuan;
        };
        #action {^³¤½­¶É´¬$} {
            shangchuan;
        };
        #class guohe.inner close;

        hb.pause;
        ask shao gong about huanghe;
        ask shao gong about jiang;
    };
    #alias {hb.delay} {
        #var gps_delay 1.5;
        #var gps_delay %1;
        #delay {${gps_delay}} {
            #math hb_path_index ${hb_path_index}+1;
            hb.run;
        };
    };
    #alias {hb.busy} {
        on_unbusy {
            #math hb_path_index ${hb_path_index}+1;
            hb.run;
        };
    };
    #alias {hb.clear} {
        #var tmp_blocker %1;
        #class clear_blocker.inner open;
        #action {ÄãÏëÉ±Ë­} {
            #class clear_blocker.inner kill;
            #math hb_path_index ${hb_path_index}+1;
            hb.run;
        };
        #ticker {tmp_blocker_ticker_kill} {
            killall ${tmp_blocker};
        } {5};
        #class clear_blocker.inner close;
        hb.pause;
        killall ${tmp_blocker};
    };

    #action {¿´À´¸ÃÕÒ»ú»áÌÓÅÜÁË} {
        hb.pause;
        show_to_tuiche ¶ªïÚ;
        xmpp.notify ¶ªïÚ;
        hb.teardown;
        hb.b;
    };

    #action {^ÂýÂýµØÄãÖÕÓÚÓÖÓÐÁËÖª¾õ....} {
        show_to_tuiche ¹ÒÁË;
        notify.alert ¹ÒÁË;
        xmpp.notify ¹ÒÁË;
        hb.teardown;
        hb.b;
    };

    #action {^ÄãµÄÑÛÇ°Ò»ºÚ£¬½ÓÖøÊ²Ã´Ò²²»ÖªµÀÁË} {
        hb.pause;
    };

    #action {ÄãÏëÉ±Ë­£¿} {
        hb.retry;
    };

    #action {ïÚ³µ»¹Ã»ÓÐ¸úÉÏÀ´ÄØ,×ßÂýµã.} {
        hb.retry;
    };
    
    #action {Äã»¹ÊÇÏÈ°Ñ¶ÔÊÖ½â¾öÁËÔÙËµ°É} {
        #math hb_retry_count ${hb_retry_count}+1;
        #if {${hb_retry_count} > 3} {
            #var hb_retry_count 0;
            killall;
        };
        hb.retry;
    } {1};

    #action {ïÚ³µºôÀ²Ò»ÉùÉ¢ÁË¼Ü} {
        hb.pause;
        show_to_tuiche ïÚ³µºôÀ²Ò»ÉùÉ¢ÁË¼Ü;
        hb.b;
    };

    #action {busy_for_move} {
        hb.retry;
    };

    #action {^Äã¸Ï×ÅïÚ³µÊ»ÁË¹ýÀ´¡£$} {
        #var hb_retry_count 0;
        #if {${hb_paused} == 0} {
            #math hb_path_index ${hb_path_index}+1;
            hb.run;
        };
    };

    #action {½Ù·Ë¸öÆð×Ý¶ÝÈë°µÀï²»¼ûÁË} {
        hb.detect_enemy;
        raw;
        hb.retry;
    };

    #action {^Õâ¸ö·½Ïò} {
        #if {${hb_paused} == 0} {
            hb.pause;
            hb.resume;
        };
    };

    #action {½Ù·Ë³ÃÄã²»×¢Òâ£¬ÍÆ×ÅïÚ³µ¾ÍÅÜ£¬Äã¸Ï½ô×·ÁËÉÏÈ¥¡£} {
        hb.pause;
        @setenv{mixin_lunci;6};
        #delay {hb_delay} {
            hb.resume;
        } {3};
    };

    #action {½Ù·ËÉìÊÖÒ»À¹µÀ} {
        war;
        hb.retry;
    };

    #action {Äã³¤Ð¦Ò»Éù£¬¿ªÊ¼¶ÔÖÜÎ§ÖÚÈËÍ´ÏÂÉ±ÊÖ£¡} {
        #var hb_first_kill 1;
    };

    #action {½Ù·ËÍ»È»´Ó°µ´¦ÌøÁË³öÀ´} {
        hb.detect_enemy;
        #if {${hb_first_kill} == 0} {
            killall robber;
        };
        #else {
            war;
        };
    };

    #action {Î§ÉÏÀ´¼¸¸ö»ï¼Æ½«ïÚ³µÀ­ÁË½øÈ¥} {
        @setenv{hb_state;ENDED};
        hb.pause;
        raw;
        show_to_tuiche ÈÎÎñÍê³É;
        notify escort done;
        hb.teardown;
        on_truce {
            #if {@getenv{hb_lunci} == @getenv{mixin_lunci}} {
                chain on_sell get.qian get.san repair special_repair gem.combine hb.b;
            };
            #else {
                hb.b;
            };
        };
    } {1};

    #class hb_setup_inner close;

    #var hb_elapsed_time 0;
    #ticker {hb_ticker} {
        #math hb_elapsed_time ${hb_elapsed_time}+1;
        show_to_tuiche ${hb_info} --> ${hb_elapsed_time}:00;
    } {60};
};

#alias {hb.retry} {
    #if {${hb_paused} == 0} {
        #delay {hb_move} {
            hb.run;
        } {1.5};
    };
};

#alias {hb.pause} {
    #var hb_paused 1;
    #undelay {hb_move};
};

#alias {hb.get_owner} {
    #action {%S %S×ÜïÚÍ· %S(%*)} {
        #unaction {%S %S×ÜïÚÍ· %S(%*)};
        @setenv{hb_owner;@lower{%%4}};
    };
    #alias {get_pos_done} {
        @setenv{hb_owner_loc;${pos.room}};
    };
    get_pos {
        get_pos_done;
    };
};

#alias {hb.d} {
    #if {"@getenv{hb_state}" == "GOT_CAIWU"} {
        give cai wu to @getenv{hb_owner};
    };
    #elseif {"@getenv{hb_state}" == "ENDED"} {
        #if {@getenv{hb_lunci} == @getenv{mixin_lunci}} {
            @setenv{hb_lunci;0};
            notify.alert next mixin;
            xmpp.notify next mixin;
            play alert.wav;
        };
        #else {
            ask @getenv{hb_owner} about finish;
        };
    };
    #elseif {"@getenv{hb_state}" == "GOT_MIXIN"} {
        give mixin to @getenv{hb_owner};
        xian mixin;
    };
    #else {
        hb.f;
        #if {${hb_auto} == 1} {
            hb.start;
        };
    };
};

#alias {hb.q} {
    #if {"%1" != ""} {
        getesc %1;
    };
    #else {
        listesc;
    }
};


#alias {hb.f} {
    @setenv{hb_lunci;0};
    @setenv{hb_lunci_total;0};
    @setenv{hb_state;NIL};
    @setenv{mixin_lunci;6};
    hb.teardown;
    ask @getenv{hb_owner} about fail;
};

#alias {hb.b} {
    gt @getenv{hb_owner_loc};
    on_there {
        hb.d;
    };
};

#alias {hb.start} {
    set brief 2;
    #var hb_auto 1;

    #class hb.auto.inner open;
    #action {^Äã²»ÊÇ²ÅÒªÁËÈÎÎñÂð} {
        hb.f;
        on_unbusy {
            hb.start;
        };
    };

    #action {ÄãÒ»¹²±»½±ÀøÁË£º} {
        #class tmp.inner open;
        #action {%*µã¾­Ñé£»} {
            #class tmp.inner kill;
            show_to_info @ctd{%%%1} µã¾­Ñé;
        };
        #delay {hb_auto_delay} {
            #if {${hb_auto} == 1} {
                hb.start;
            };
        } {3};
        #class tmp.inner close;
    };

    #gag mx done;
    #action {${char_name}°ï%*×·»Ø²ÆÎï£¬¶îÍâ»ñµÃ%*µã¾­Ñé} {
        show_to_info ¶îÍâ»ñµÃ @ctd{%%2} µã¾­Ñé;
        #show mx done;
    };

    #alias {got_gem} {
        #action {Äã½«ÊÖÖÐ%*{¡ò|¡î|¡ï}%*·Å½øÁË±¦Ê¯´ü} {
            show_to_info µô±¦: %%%1%%%2%%%3;
            notify.info %%%1%%%2%%%3;
            gem.record %%%1%%%2%%%3;
            #var gem_level @gemlevel{%%%1};
            play gem2.wav;
            xmpp.notify µô±¦: %%%1%%%2%%%3;
        };
        pack gem;
        #delay {pack_gem} {
            #unaction {Äã½«ÊÖÖÐ%*{¡ò|¡î|¡ï}%*·Å½øÁË±¦Ê¯´ü};
        } {3};
    };

    #action {ÍÛ£¬ÄãÌ«À÷º¦ÁË£¬ÕâÃ´¿ì¾Í°ÑÕâÐ©²ÆÎï×·»Ø£¬ÎÒÓÐÖØÐ»£¡} {
        got_gem;
        #show mx done;
    };

    #action {µôÁË³öÀ´Ò»¿Å} {
        got_gem;
    };

    #action {%d%s%S%s%S%s´ýÈÏÁì} {
        #var getesc_id %%1;
        #var getesc_address %%3;
        #var score @getesc_get_score{${getesc_address}};
        #if {${score} > ${getesc_current_score}} {
            #var getesc_current_score $score;
            #var getesc_current_id ${getesc_id};
        };
    };

    #action {À´ÈÏÁìÑºïÚÈÎÎñ} {
        #if {${getesc_current_id} != 0} {
            #var hb_rotate_location_count 0;
            hb.q ${getesc_current_id};
        };
        #else {
            #math hb_rotate_location_count ${hb_rotate_location_count} + 1;
            #if {${hb_rotate} == 1 && ${hb_rotate_location_count} > 3 && "${hb_rotate_location}" != "NIL"} {
                #var hb_rotate_location_count 0;
                hb.stop;
                gt ${hb_rotate_location};
                on_there {
                    hb.start;
                };
            };
            #else {
                #delay {hb_auto_delay} {
                    hb.start;
                } {10};
            };
        };
    };

    #action {ÇëÑ¡ÔñÆäËûÈÎÎñ} {
        #delay {hb_auto_delay} {
            #var getesc_current_score 0;
            #var getesc_current_id 0;
            hb.q;
        } {2};
    };

    #action {ÄãÉÏ´ÎÔËïÚÌ«ÐÁ¿àÁË} {
        #delay {hb_auto_delay} {
            hb.q;
        } {10};
    };

    #action {ÄãËùÁìµÄÈÎÎñÔÚÈÎÎñÁÐ±íÖÐ²¢²»´æÔÚ} {
        #delay {hb_auto_delay} {
            hb.q;
        } {2};
    };

    #action {${char_name}°ÑÕâÅúºì»õËÍµ½%*ËûÒÑ¾­ÅÉÁË¸ö»ï¼ÆÃû½Ð%*µ½%*¸½½ü½ÓÄã} {
        @setenv{hb_state;STARTED};
        @setenv{hb_lunci;@eval{@getenv{hb_lunci}+1}};
        INVOKE gps.get_area %%1;
        #var hb_dest ${gps.area}%%3;
        #var hb_info %%2|${hb_dest};
        show_to_tuiche ${hb_info};
        autopp.set %%2;

        hb.setup;
        hb.resume;
    } {1};

    #action {µÝ¸øÄãÒ»·âÃÜÐÅ} {
        @setenv{hb_state;GOT_MIXIN};
        @setenv{hb_lunci_total;@eval{@getenv{hb_lunci_total}+1}};
        @setenv{hb_lunci;0};
        show_to_tuiche ÃÜÐÅ;
        xian mixin;
    };

    #class hb.auto.inner close;

    @declarenv{hb_state;NIL};
    @declarenv{mixin_lunci;6};

    hb.get_owner;

    #if {"@getenv{hb_state}" == "GOT_CAIWU"} {
        show_to_info ½»²ÆÎïÏÈ;
    };
    #if {"@getenv{hb_state}" == "GOT_MIXIN"} {
        show_to_info ÃÜÐÅ;
    };
    #elseif {"@getenv{hb_state}" == "STARTED"} {
        hb.f;
    };
    #else {
        #math next_lunci @getenv{hb_lunci}+1;
        show_to_quest ÍÆ³µ: @getenv{hb_lunci_total}+${next_lunci}: ×¼±¸;
        on_health {hb.q};
    };
};


#alias {hb.stop} {
    #var hb_auto 0;
    #class hb.auto.inner kill;
    #undelay {hb_auto_delay};
    #unticker {hb_ticker};
    dz.cancel;
};

#alias {mx} {
    gt %1;
    on_there {
        mx.q;
    };
    #action {mx done} {
        #unaction {mx done};
        xmpp.notify ÃÜÐÅÍê³É;
    };
};

#alias {mx.q} {
    #class mx.inner open;
    #action {Ò»¸ö»ï¼ÆÍÚ×Å±ÇÊº×ßÁË³öÀ´£¬µÀ£ºÄãÕÒÎÒÉ¶ÊÂ} {
        l;
    };
    #action {²ÆÎïµÄ»ï¼Æ %S(%S)} {
        #format {tmp_huoji} {%l} {%%2};
        #class mx.yao.inner open;
        #action {°ÑÒ»°ü²ÆÎïÔÒÏòÄã£¬Ò»×ªÑÛ²»¼ûÁË¡£} {
            @setenv{hb_state;GOT_CAIWU};
            show_to_tuiche ÄÃµ½²Æ±¦;
            play get_item.wav;
            #class mx.yao.inner kill;
            #class mx.inner kill;
            on_truce {
                hb.b;
            };
        };
        #action {ÕâÀïÃ»ÓÐÕâ¸öÈË} {
            #class mx.yao.inner kill;
        };
        #ticker {yao} {
            ask $tmp_huoji about yao;
        }{0.5};
        #class mx.yao.inner close;
    } {1};
    #class mx.inner close;
    zhaoxun;
};

#alias {hb.p} {
    chain get.san get.qian get.fan get.bao repair;
};

#action {Äã¸ø%*Ò»Ð©Ê§×ÙµÄ²ÆÎï} {
    @setenv{hb_state;NIL};
    @setenv{mixin_lunci;5};
    #delay {hb_auto_delay} {
        #if {${hb_auto} == 1} {
            hb.start;
        };
    } {3};
};

#alias {show_to_tuiche} {
    show_to_quest ÍÆ³µ: @getenv{hb_lunci_total}+@getenv{hb_lunci}: %0;
};

#alias {hb.check_robber} {
    #delay {detect_enemy_delay} {
        #var hb_robber_count ${tmp_robber_count};
        #class detect_enemy.inner kill;
    } {1};
    #math tmp_robber_count ${tmp_robber_count}+1;
    #var tmp_score @mapget{robber_score;%1};
    #if {${tmp_score} > ${robber_score}} {
        #var robber_score ${tmp_score};
        #var enemy ${char_id}'s robber ${tmp_robber_count};
    };
};

#alias {hb.resume} {
    #var hb_state @getenv{hb_state};
    #if {"${hb_state}" == "STARTED"} {
        hb.goto_dest_area;
    };
    #elseif {"${hb_state}" == "TRAVERSE"} {
        hb.traverse;
    };
};

#alias {hb.goto_dest_area} {
    #var hb_paused 0;
    #alias {gps_check_room_done} {
        #if {${gps.roomno} == -1} {
            #delay {1} {
                #show {GPS: µ±Ç°·¿¼äÎ´¼ÇÂ¼, ÎÞ·¨ÐÐ×ß};
            };
        };
        #else {
            #var gps.from_roomno ${gps.roomno};
            INVOKE gps.get_room ${hb_dest};
            INVOKE gps.get_path ${gps.from_roomno} ${gps.roomno} "1,1,1,-1,-1,1";
            #var hb_path ${gps_path};
            #var hb_path_index 1;
            #list hb_path size hb_path_size;
            #if {${hb_path_size} == 0} {
                #delay {1} {
                    #show {GPS: Ä¿±ê·¿¼ä²»¿É´ï, ÎÞ·¨ÐÐ×ß};
                };
            };
            #else {
                #if {@getenv{mixin_lunci} == 5} {
                    #nop Ä¥²ä;
                    #math additional_path_size ${hb_max_path_size} - ${hb_path_size};
                    #if {${additional_path_size} > 0} {
                        #list hb_path get 2 first_step;
                        #var second_step @opposite{${first_step}};
                        #var cnt 0;
                        #while {${cnt} < ${additional_path_size}} {
                            #list hb_path insert 2 ${second_step};
                            #list hb_path insert 2 ${first_step};
                            #math cnt $cnt+2;
                        };
                        #list hb_path size hb_path_size;                        
                    };                    
                };
                hb.run;
            };
        };  
    };
    gps.check_room {
        gps_check_room_done;
    };
};

#alias {hb.detect_enemy} {
    #class detect_enemy.inner open;
    #action {~ÄãÏëÒªÊÕ[1;31m½Ù·Ë[2;37;0mÎªµÜ×Ó} {
        hb.check_robber quanzhen;
    };
    #action {~ÄãÏëÒªÊÕ[1;32m½Ù·Ë[2;37;0mÎªµÜ×Ó} {
        hb.check_robber shaolin;
    };
    #action {~ÄãÏëÒªÊÕ[1;33m½Ù·Ë[2;37;0mÎªµÜ×Ó} {
        hb.check_robber gaibang;
    };
    #action {~ÄãÏëÒªÊÕ[1;34m½Ù·Ë[2;37;0mÎªµÜ×Ó} {
        hb.check_robber xingxiu;
    };
    #action {~ÄãÏëÒªÊÕ[1;35m½Ù·Ë[2;37;0mÎªµÜ×Ó} {
        hb.check_robber huashan;
    };
    #action {~ÄãÏëÒªÊÕ[1;36m½Ù·Ë[2;37;0mÎªµÜ×Ó} {
        hb.check_robber taohua;
    };
    #action {~ÄãÏëÒªÊÕ[1;37m½Ù·Ë[2;37;0mÎªµÜ×Ó} {
        hb.check_robber wudang;
    };
    #class detect_enemy.inner close;

    #var enemy NULL;
    #var tmp_robber_count 0;
    #var hb_robber_count 0;
    #var robber_score 0;
    shou ${char_id}'s robber 1;
    shou ${char_id}'s robber 2;
    shou ${char_id}'s robber 3;
    shou ${char_id}'s robber 4;
};
#class hubiao close
